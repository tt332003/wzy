<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商家订单管理端</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    body { padding: 20px; background-color: #f8f8f8; }
    .title { text-align: center; margin-bottom: 30px; color: #333; font-size: 24px; }
    .order-list { max-width: 800px; margin: 0 auto; }
    .order-item { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .order-table { font-weight: bold; color: #e63946; }
    .order-status { padding: 5px 10px; border-radius: 4px; font-size: 14px; }
    .status-wait { background: #ffd166; color: #fff; }
    .status-making { background: #06d6a0; color: #fff; }
    .status-done { background: #118ab2; color: #fff; }
    .order-body { margin-bottom: 10px; }
    .goods-item { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
    .order-footer { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #666; flex-wrap: wrap; gap: 10px; }
    .order-phone { color: #333; font-weight: bold; }
    .order-time { font-size: 12px; }
    .status-btn-group { display: flex; gap: 10px; }
    .status-btn { padding: 5px 10px; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 12px; }
    .btn-wait { background: #ffd166; }
    .btn-making { background: #06d6a0; }
    .btn-done { background: #118ab2; }
    .loading { text-align: center; color: #666; padding: 20px; }
    .error-tip { text-align: center; color: #e63946; padding: 20px; }
    .empty-tip { text-align: center; color: #666; padding: 20px; }
  </style>
  <!-- 引入Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- 登录模块 -->
  <div id="loginBox">
    <h2>商家登录</h2>
    <input type="email" id="emailInput" placeholder="商家邮箱">
    <input type="password" id="pwdInput" placeholder="商家密码">
    <button id="loginBtn">登录</button>
  </div>

  <!-- 订单管理模块（默认隐藏） -->
  <div id="orderBox" style="display: none;">
    <h1 class="title">餐饮店订单管理</h1>
    <div id="orderList" class="order-list"></div>
  </div>

  <style>
    /* 登录模块样式优化 */
    #loginBox {
      max-width: 400px;
      margin: 50px auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #loginBox h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    #loginBox input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #eee;
      border-radius: 4px;
      outline: none;
    }
    #loginBox button {
      width: 100%;
      background: #07c160;
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>

  <script>
    // ===================== 唯一的Supabase初始化（无任何重复） =====================
    const supabaseUrl = "https://oqkdcxmtxrwvsocgbpepp.supabase.co";
    const supabaseKey = "sb_publishable_dOIM3vMGbHXyBaZIM3TZeg_dBSy7t6y";
    // 初始化配置：规避跟踪防护报错
    const supabaseInstance = supabase.createClient(supabaseUrl, supabaseKey, {
      auth: {
        storage: false,
        autoRefreshToken: false,
        persistSession: false,
      }
    });

    // 全局状态
    let isLoggedIn = false;

    // ===================== 登录函数 =====================
    async function handleLogin() {
      const email = document.getElementById('emailInput').value.trim();
      const pwd = document.getElementById('pwdInput').value.trim();

      if (!email || !pwd) {
        alert('请填写完整的邮箱和密码！');
        return;
      }

      try {
        const { error } = await supabaseInstance.auth.signInWithPassword({
          email: email,
          password: pwd
        });

        if (error) throw error;

        // 登录成功
        isLoggedIn = true;
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('orderBox').style.display = 'block';
        await loadOrders();
        listenOrderChange();
        alert('登录成功！');
      } catch (err) {
        console.error('登录失败：', err);
        alert(`登录失败：${err.message}`);
      }
    }

    // ===================== 加载订单函数 =====================
    async function loadOrders() {
      if (!isLoggedIn) {
        alert('请先登录！');
        return;
      }

      const orderDom = document.getElementById('orderList');
      orderDom.innerHTML = '<p class="loading">正在加载订单...</p>';

      try {
        const { data, error } = await supabaseInstance
          .from('orders')
          .select('*')
          .order('create_time', { ascending: false });

        if (error) throw error;
        renderOrderList(data || []);
      } catch (err) {
        console.error('加载订单失败：', err);
        orderDom.innerHTML = '<p class="error-tip">订单加载失败，请刷新页面</p>';
      }
    }

    // ===================== 渲染订单函数 =====================
    function renderOrderList(orders) {
      const orderDom = document.getElementById('orderList');
      if (orders.length === 0) {
        orderDom.innerHTML = '<p class="empty-tip">暂无订单</p>';
        return;
      }

      let html = '';
      orders.forEach(item => {
        // 菜品列表
        let goodsHtml = '';
        item.goods.forEach(good => {
          goodsHtml += `
            <div class="goods-item">
              <span>${good.name} × ${good.num}</span>
              <span>¥${(good.price * good.num).toFixed(2)}</span>
            </div>
          `;
        });

        // 状态样式
        let statusCls = '';
        if (item.status === '待接单') statusCls = 'status-wait';
        if (item.status === '制作中') statusCls = 'status-making';
        if (item.status === '已完成') statusCls = 'status-done';

        // 格式化时间
        const time = new Date(item.create_time).toLocaleString('zh-CN');

        // 单个订单
        html += `
          <div class="order-item" data-id="${item.id}">
            <div class="order-header">
              <span class="order-table">${item.table_num}号桌</span>
              <span class="order-status ${statusCls}">${item.status}</span>
            </div>
            <div class="order-body">${goodsHtml}</div>
            <div class="order-footer">
              <div>
                <span class="order-phone">${item.phone}</span>
                <span> | 总价：¥${item.total_price.toFixed(2)}</span>
                <span class="order-time"> | 下单时间：${time}</span>
              </div>
              <div class="status-btn-group">
                <button class="status-btn btn-wait" onclick="updateOrderStatus('${item.id}', '待接单')">待接单</button>
                <button class="status-btn btn-making" onclick="updateOrderStatus('${item.id}', '制作中')">制作中</button>
                <button class="status-btn btn-done" onclick="updateOrderStatus('${item.id}', '已完成')">已完成</button>
              </div>
            </div>
          </div>
        `;
      });

      orderDom.innerHTML = html;
    }

    // ===================== 修改订单状态函数 =====================
    async function updateOrderStatus(orderId, newStatus) {
      if (!isLoggedIn) {
        alert('请先登录！');
        return;
      }

      try {
        const { error } = await supabaseInstance
          .from('orders')
          .update({ status: newStatus })
          .eq('id', orderId);

        if (error) throw error;
        await loadOrders();
        alert(`订单已更新为「${newStatus}」`);
      } catch (err) {
        console.error('修改订单状态失败：', err);
        alert('修改失败，请重试');
      }
    }

    // ===================== 监听订单实时变化 =====================
    function listenOrderChange() {
      supabaseInstance
        .channel('order-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, () => {
          loadOrders();
        })
        .subscribe();
    }

    // ===================== 页面加载完成绑定事件 =====================
    window.onload = function() {
      // 绑定登录按钮点击事件
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      console.log('页面加载完成，请登录');
    };
  </script>
</body>
</html>
