<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„å°åº— - ä¸‹å•é¡µ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
    body { padding: 20px; background-color: #f8f8f8; }
    .shop-title { text-align: center; margin-bottom: 20px; color: #333; font-size: 22px; }
    .table-select { margin: 15px 0; padding: 10px; background: #fff; border-radius: 8px; }
    .table-select label { font-weight: bold; color: #555; font-size: 14px; }
    .table-select select { padding: 5px; margin-left: 10px; border: 1px solid #eee; border-radius: 4px; outline: none; }
    .goods-list { margin: 10px 0; }
    .goods-item { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .goods-name { font-size: 18px; color: #333; margin-bottom: 5px; }
    .goods-price { color: #ff4400; font-weight: bold; margin-bottom: 10px; font-size: 16px; }
    .goods-desc { color: #666; font-size: 14px; margin-bottom: 15px; line-height: 1.5; }
    /* æ•°é‡æ§åˆ¶æ ·å¼ */
    .count-control { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .count-btn { width: 30px; height: 30px; border: 1px solid #eee; border-radius: 4px; background: #f5f5f5; cursor: pointer; font-size: 16px; transition: background 0.3s; }
    .count-btn:hover { background: #eaeaea; }
    .count-input { width: 50px; height: 30px; text-align: center; border: 1px solid #eee; border-radius: 4px; outline: none; }
    .count-input:focus { border-color: #07c160; }
    .add-cart-btn { background: #07c160; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
    .add-cart-btn:hover { background: #06b055; }
    .cart { background: #fff; padding: 15px; border-radius: 8px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .cart-title { font-weight: bold; margin-bottom: 10px; color: #333; font-size: 18px; }
    .cart-info { color: #666; margin: 5px 0; line-height: 1.6; white-space: pre-line; font-size: 14px; }
    .total-price { font-size: 16px; color: #ff4400; font-weight: bold; margin: 15px 0; }
    .phone-input { width: 100%; padding: 8px; border: 1px solid #eee; border-radius: 4px; margin: 10px 0; outline: none; }
    .phone-input:focus { border-color: #07c160; }
    .submit-btn { width: 100%; background: #07c160; color: #fff; border: none; padding: 12px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
    .submit-btn:hover { background: #06b055; }
    .no-goods { text-align: center; padding: 20px; background: #fff; border-radius: 8px; color: #666; font-size: 14px; }
    .error-tip { text-align: center; padding: 20px; background: #fff; border-radius: 8px; color: #ff4400; font-size: 14px; }
    .loading { text-align: center; padding: 20px; background: #fff; border-radius: 8px; color: #666; font-size: 14px; }
  </style>
  <!-- å¼•å…¥Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1 class="shop-title">æˆ‘çš„å°åº—</h1>

  <!-- æ¡Œå·é€‰æ‹© -->
  <div class="table-select">
    <label>é€‰æ‹©æ¡Œå·ï¼š</label>
    <select id="tableSelect">
      <option value="1">1å·æ¡Œ</option>
      <option value="2">2å·æ¡Œ</option>
      <option value="3">3å·æ¡Œ</option>
      <option value="4">4å·æ¡Œ</option>
      <option value="5">5å·æ¡Œ</option>
    </select>
  </div>

  <!-- å•†å“åˆ—è¡¨ -->
  <div class="goods-list" id="goodsList"></div>

  <!-- è´­ç‰©è½¦ -->
  <div class="cart">
    <h3 class="cart-title">æˆ‘çš„è´­ç‰©è½¦</h3>
    <p class="cart-info" id="cartInfo">è´­ç‰©è½¦ä¸ºç©º</p>
    <p class="total-price">æ€»ä»·ï¼šÂ¥<span id="totalPrice">0.00</span></p>
    <input type="tel" class="phone-input" id="phoneInput" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·">
    <button class="submit-btn" onclick="submitOrder()">æäº¤è®¢å•</button>
  </div>

  <script>
    // 1. åˆå§‹åŒ–Supabaseï¼ˆæ›¿æ¢ä¸ºä½ çš„URLå’Œå¯å‘å¸ƒå¯†é’¥ï¼‰
    const supabaseUrl = "https://oqkdcxmtrxwvsocgbepp.supabase.co";
    const supabaseKey = "sb_publishable_dOIM3vMGbHXyBaZIM3TZeg_dBSy7t6y..."; // æ›¿æ¢ä¸ºä½ çš„å®Œæ•´å¯å‘å¸ƒå¯†é’¥
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 2. å…¨å±€å˜é‡
    let cartData = [];
    let goodsList = []; // å­˜å‚¨ä»äº‘ç«¯è·å–çš„èœå“æ•°æ®

    // 3. é¡µé¢åŠ è½½åè·å–äº‘ç«¯èœå“
    window.onload = async function() {
      await getGoodsFromSupabase();
      renderGoodsList(goodsList);
      updateCartInfo();
    };

    // 4. ä»Supabaseäº‘ç«¯è·å–èœå“
    async function getGoodsFromSupabase() {
      const goodsListDom = document.getElementById('goodsList');
      goodsListDom.innerHTML = '<p class="loading">æ­£åœ¨åŠ è½½èœå“...</p>';

      try {
        const { data, error } = await supabase
          .from('goods')
          .select('*')
          .eq('is_sale', true);

        if (error) {
          throw error;
        }

        goodsList = data || [];
      } catch (err) {
        console.error("è·å–èœå“å¤±è´¥ï¼š", err);
        goodsListDom.innerHTML = '<p class="error-tip">èœå“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</p>';
      }
    }

    // 5. æ¸²æŸ“èœå“åˆ—è¡¨
    function renderGoodsList(goods) {
      const goodsListDom = document.getElementById('goodsList');
      if (goods.length === 0) {
        goodsListDom.innerHTML = '<p class="no-goods">æš‚æ— ä¸Šæ¶èœå“</p>';
        return;
      }

      goodsListDom.innerHTML = '';
      goods.forEach(good => {
        const countInputId = `count_${good.id}`;
        goodsListDom.innerHTML += `
          <div class="goods-item" data-id="${good.id}">
            <h3 class="goods-name">${good.name || 'æœªå‘½åå•†å“'}</h3>
            <p class="goods-price">Â¥${good.price.toFixed(2)}</p>
            <p class="goods-desc">${good.desc || 'æš‚æ— å•†å“æè¿°'}</p>
            <div class="count-control">
              <button class="count-btn" onclick="changeGoodsCount('${countInputId}', -1)">-</button>
              <input type="number" id="${countInputId}" class="count-input" value="1" min="1" max="99" oninput="limitCount(this)">
              <button class="count-btn" onclick="changeGoodsCount('${countInputId}', 1)">+</button>
            </div>
            <button class="add-cart-btn" onclick="addToCart('${good.id}', '${good.name}', ${good.price}, '${countInputId}')">åŠ å…¥è´­ç‰©è½¦</button>
          </div>
        `;
      });
    }

    // 6. é™åˆ¶æ•°é‡è¾“å…¥èŒƒå›´
    function limitCount(inputDom) {
      let count = parseInt(inputDom.value);
      if (isNaN(count)) count = 1;
      count = Math.max(1, Math.min(99, count));
      inputDom.value = count;
    }

    // 7. è°ƒæ•´å•†å“æ•°é‡
    function changeGoodsCount(inputId, change) {
      const inputDom = document.getElementById(inputId);
      let currentCount = parseInt(inputDom.value);
      currentCount += change;
      currentCount = Math.max(1, Math.min(99, currentCount));
      inputDom.value = currentCount;
    }

    // 8. åŠ å…¥è´­ç‰©è½¦
    function addToCart(goodsId, goodsName, goodsPrice, countInputId) {
      const selectCount = parseInt(document.getElementById(countInputId).value);
      const existItem = cartData.find(item => item.id === goodsId);

      if (existItem) {
        existItem.num += selectCount;
      } else {
        cartData.push({
          id: goodsId,
          name: goodsName,
          price: goodsPrice,
          num: selectCount
        });
      }

      document.getElementById(countInputId).value = 1;
      updateCartInfo();
      alert(`${goodsName} Ã— ${selectCount} å·²æˆåŠŸåŠ å…¥è´­ç‰©è½¦`);
    }

    // 9. æ›´æ–°è´­ç‰©è½¦ä¿¡æ¯
    function updateCartInfo() {
      const cartInfoDom = document.getElementById('cartInfo');
      const totalPriceDom = document.getElementById('totalPrice');
      let cartText = '';
      let totalPrice = 0;

      if (cartData.length === 0) {
        cartText = 'è´­ç‰©è½¦ä¸ºç©º';
        totalPrice = 0;
      } else {
        cartData.forEach(item => {
          const itemTotal = item.price * item.num;
          cartText += `${item.name} Ã— ${item.num} ï¼ˆÂ¥${itemTotal.toFixed(2)}ï¼‰\n`;
          totalPrice += itemTotal;
        });
        cartText = cartText.slice(0, -1);
      }

      cartInfoDom.innerText = cartText;
      totalPriceDom.innerText = totalPrice.toFixed(2);
    }

    // 10. æäº¤è®¢å•åˆ°äº‘ç«¯
    async function submitOrder() {
      const phone = document.getElementById('phoneInput').value.trim();
      const tableNum = document.getElementById('tableSelect').value;

      if (!/^1[3-9]\d{9}$/.test(phone)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ï¼');
        return;
      }
      if (cartData.length === 0) {
        alert('è¯·å…ˆæ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ï¼');
        return;
      }

      const totalPrice = parseFloat(document.getElementById('totalPrice').innerText);
      const orderData = {
        table_num: tableNum,
        goods: cartData,
        total_price: totalPrice,
        phone: phone,
        status: "å¾…æ¥å•",
        create_time: new Date().toISOString()
      };

      try {
        const { error } = await supabase
          .from('orders')
          .insert([orderData]);

        if (error) {
          throw error;
        }

        alert(`ğŸ‰ ä¸‹å•æˆåŠŸï¼
æ¡Œå·ï¼š${tableNum}å·æ¡Œ
æ€»ä»·ï¼šÂ¥${totalPrice.toFixed(2)}
æ‰‹æœºå·ï¼š${phone}
å•†å®¶å°†å°½å¿«ä¸ºæ‚¨å¤‡é¤`);

        cartData = [];
        updateCartInfo();
        document.getElementById('phoneInput').value = '';
      } catch (err) {
        console.error("æäº¤è®¢å•å¤±è´¥ï¼š", err);
        alert("ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•");
      }
    }
  </script>
</body>
</html>